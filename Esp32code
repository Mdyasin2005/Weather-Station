#define BLYNK_TEMPLATE_ID "TMPL35xVFgfsD"
#define BLYNK_DEVICE_NAME "WeatherStation"
#define BLYNK_AUTH_TOKEN "3qHOMaq5tMQetWSG515klF1a7I8-fnFU"

#define BLYNK_PRINT Serial

#include <WiFi.h>
#include <WiFiClient.h>
#include <BlynkSimpleEsp32.h>
#include <DHT.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>

// ---------------- Pins ----------------
#define DHTPIN 4
#define DHTTYPE DHT11

const int PIN_PRESSURE = 32; // Pot for BMP180 replacement
const int PIN_RAIN     = 35; // Pot for Rain sensor replacement
const int PIN_LDR      = 32; // Changed to avoid conflict

// ---------------- Objects ----------------
DHT dht(DHTPIN, DHTTYPE);
LiquidCrystal_I2C lcd(0x27, 16, 2);

// ---------------- WiFi & Blynk ----------------
char auth[] = "3qHOMaq5tMQetWSG515klF1a7I8-fnFU";
char ssid[] = "NOT_FOR_YOU";
char pass[] = "tryagain";

BlynkTimer timer;

// ---------------- Sensor Reading Function ----------------
void sendSensorData() {
  float t = dht.readTemperature();
  float h = dht.readHumidity();
  if (isnan(t) || isnan(h)) {
    Serial.println("DHT11 read error");
    t = -127; h = -1;
  }

  int rawPress = analogRead(PIN_PRESSURE);
  int rawRain  = analogRead(PIN_RAIN);
  int rawLdr   = analogRead(PIN_LDR);

  float pressure_hPa = 300.0 + (rawPress / 4095.0) * 800.0;
  float rain_pct     = (rawRain / 4095.0) * 100.0;
  bool  rain_flag    = rawRain > 2500;
  float light_pct    = (rawLdr / 4095.0) * 100.0;

  Serial.printf("T=%.1fC H=%.0f%% | P=%.0fhPa | Light=%.0f%% | Rain=%.0f%% (%s)\n",
                t, h, pressure_hPa, light_pct, rain_pct, rain_flag ? "WET" : "DRY");

  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("T:");
  lcd.print(t, 1);
  lcd.print("C H:");
  lcd.print(h, 0);
  lcd.print("%");

  lcd.setCursor(0, 1);
  lcd.print("P:");
  lcd.print(pressure_hPa, 0);
  lcd.print("hPa");

  delay(1000);
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Light:");
  lcd.print(light_pct, 0);
  lcd.print("%");
  lcd.setCursor(0, 1);
  lcd.print("Rain:");
  lcd.print(rain_pct, 0);
  lcd.print("% ");
  lcd.print(rain_flag ? "WET" : "DRY");

  Blynk.virtualWrite(V0, t);
  Blynk.virtualWrite(V1, h);
  Blynk.virtualWrite(V2, pressure_hPa);
  Blynk.virtualWrite(V3, light_pct);
  Blynk.virtualWrite(V4, rain_pct);
  Blynk.virtualWrite(V5, rain_flag);
}

// ---------------- Setup ----------------
void setup() {
  Serial.begin(115200);
  dht.begin();
  analogReadResolution(12);

  lcd.init();
  lcd.backlight();
  lcd.setCursor(0, 0);
  lcd.print("IoT Wx Station");
  lcd.setCursor(0, 1);
  lcd.print("Connecting...");

  Blynk.begin(auth, ssid, pass);
  timer.setInterval(2000L, sendSensorData);
}

// ---------------- Loop ----------------
void loop() {
  Blynk.run();
  timer.run();
}
